## flink-connector-http
- ä¸ºä»€ä¹ˆéœ€è¦ http å¼‚æ­¥ç»´è¡¨ï¼Ÿ
> 1. Http LookupTableå¯¹äºç»“åˆ TensorFlow ç­‰ç®—æ³•ç³»ç»Ÿéå¸¸æœ‰ç”¨ï¼Œè¿™äº›ç³»ç»Ÿä¸å®¹æ˜“å†…ç½® flinkã€‚(ç®—æ³•ç®¡ç†æ›´å…·å¯æ§æ€§)
> 2. ç°åœ¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿæ”¯æŒ Rest api è¯·æ±‚ï¼ŒHttp æŸ¥è¡¨ä½œä¸º Dimension Table ç”¨ä¾‹å¯èƒ½æ˜¯æœ€çµæ´»çš„æ–¹å¼ã€‚
- åº•å±‚å®ç°æ–¹å¼
> é‡‡ç”¨[Apache-http-client-5](https://hc.apache.org/httpcomponents-client-ga/) å®ç°çš„å¼‚æ­¥`http` ç»´è¡¨

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹
```shell
git clone https://github.com/streamxhub/streamx-connector.git
cd streamx-connector/flink-connector-http
# $version_withouttail ï¼š 1.14 1.13 1.12 ; é€šè¿‡ shim å±è”½ flink ç‰ˆæœ¬å·®å¼‚
mvn clean install -DskipTests -Dflink.version=$version -Dshim.version=$version_withouttail

```

## ä½¿ç”¨é¡»çŸ¥
**æ³¨æ„ï¼Œåªæœ‰ Http Post æ–¹æ³•å®ç°äº†æ‰€æœ‰æ•°æ®ç±»å‹æ”¯æŒï¼ŒHttp Get ä¸æ”¯æŒåµŒå¥—ç±»å‹å¦‚ï¼šmap,list,rowç­‰ã€‚ Http è¯·æ±‚å¿…é¡»è¿”å›JSON æ ·å¼ï¼›Post è¯·æ±‚`Server`ç«¯å¿…é¡»æ”¯æŒ`application/json`è¯·æ±‚æ ·å¼**

## ğŸ‰ Features
* å¼‚æ­¥çš„http lookuptable
* æ”¯æŒGet Post è¯·æ±‚ï¼Œé»˜è®¤è‡ªå¸¦è¿æ¥å¤ç”¨
* æ”¯æŒç®€å•è¯·æ±‚é™æµ
* æ”¯æŒç›‘æ§è¯·æ±‚æƒ…å†µ
* 


## ğŸ‘» ä½¿ç”¨

```sql
# ç»´è¡¨å®šä¹‰
# copy_time ä¸ºè¿”å›æ•°æ®æ ·ä¾‹ï¼Œå…¶ä»–å­—æ®µé™¤ processtime å¤–ï¼Œå‡ä¸ºè¯·æ±‚å‚æ•°å­—æ®µ
CREATE TABLE dim (
 test_bigint BIGINT,
 test_decimal DECIMAL(2,2) ,  
 test_float float,  
 test_string string,
 test_row row<a string>, 
 copy_time bigint) WITH (
   'connector' = 'http_table',
   'url' = 'http://127.0.0.1/test',
   'request.method' = 'post'
);

# æºè¡¨å®šä¹‰
CREATE TABLE source (
    test_bigint BIGINT,
    test_decimal        DECIMAL(2,2),
    order_time   AS PROCTIME (),
    test_float float,    test_string string,     test_row row<a string>) WITH (
  'connector' = 'datagen'
);

# ä½¿ç”¨æ–¹å¼
select 
  * 
from 
  source 
  left join dim FOR SYSTEM_TIME AS OF source.order_time on dim.test_bigint = source.test_bigint 
  and source.test_decimal = dim.test_decimal 
  and source.test_float = dim.test_float 
  and source.test_string = dim.test_string 
  and source.test_row = dim.test_row;
  
# http æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚
User-Agent: Apache-HttpAsyncClient/5.1.3 (Java/1.8.0_261)
Content-Length: 319
Content-Type: application/json; charset=UTF-8
Host: 127.0.0.1
Connection: keep-alive

{"test_bigint":-4443229737491929593,"test_decimal":0.87,"test_float":1.3952405E38,"test_string":"406a1d037ceca370306de3b9aa9be285d05bda5853b336d16d217d5e4703101e966008ba6cb979d3b53c14cd512c9f7b9135","test_row":{"a":"a43140c47b71a9b1e2389352c484169fb75c8cd9ccf301fa08e0b60675d3520e1c04dd918331878e9f6960ff9bc8dd11c77c"}}]

# è¿”å›è¯·æ±‚ä½“
{"test_bigint":-6708108163846343121,"test_decimal":0.58,"test_float":6.719438E36,"test_string":"1fe27e06816357fb9bbfd0be70e6c02347b0a15e93b75812a47fed32e3f0bbf53a632155575de7612985ed0eb7e3b1bd8a59","copy_time":1,"test_row":{"a":"50b9d825b1eaa37d7e7687857029b1a8d53d0f2d4d94653f7093bbe3695f868e60d9535475f913c9ccf98de6893cee1e1ebc"}}

# æŸ¥è¯¢ç»“æœ

+----+----------------------+--------------+-------------------------+--------------------------------+--------------------------------+--------------------------------+----------------------+---------------+--------------------------------+--------------------------------+--------------------------------+----------------------+
| op |          test_bigint | test_decimal |              order_time |                     test_float |                    test_string |                       test_row |         test_bigint0 | test_decimal0 |                    test_float0 |                   test_string0 |                      test_row0 |            copy_time |
+----+----------------------+--------------+-------------------------+--------------------------------+--------------------------------+--------------------------------+----------------------+---------------+--------------------------------+--------------------------------+--------------------------------+----------------------+
| +I |  2278154383963536264 |         0.43 | 2022-04-21 09:52:13.704 |                   2.1050154E38 | 55221d5dee225974b4a30e4b259... | +I[eb30195ac5c656b72b73e092... |  2278154383963536264 |          0.43 |                   2.1050154E38 | 55221d5dee225974b4a30e4b259... | +I[eb30195ac5c656b72b73e092... |                    1 |
| +I |  6168804551817045985 |         0.92 | 2022-04-21 09:52:13.709 |                   2.5027567E38 | cefa9b13dfc042aa0f3920595ed... | +I[e20845eae98fc696579977f2... |  6168804551817045985 |          0.92 |                   2.5027567E38 | cefa9b13dfc042aa0f3920595ed... | +I[e20845eae98fc696579977f2... |                    1 |
| +I |   849041297008809378 |         0.41 | 2022-04-21 09:52:13.713 |                   2.4748103E38 | 21c5a3a68ee5f9a0cfde540f8f7... | +I[98bf4fcbb6b6a1bb7e3bd0a4... |   849041297008809378 |          0.41 |                   2.4748103E38 | 21c5a3a68ee5f9a0cfde540f8f7... | +I[98bf4fcbb6b6a1bb7e3bd0a4... |                    1 |
| +I | -5148624724080265671 |         0.44 | 2022-04-21 09:52:13.716 |                    2.950303E38 | 8051eb7d99bc2eba6a107580146... | +I[950c5f43600752637cf373ae... | -5148624724080265671 |          0.44 |                    2.950303E38 | 8051eb7d99bc2eba6a107580146... | +I[950c5f43600752637cf373ae... |                    1 |
| +I |  5030070719974405429 |         0.21 | 2022-04-21 09:52:13.719 |                    1.409689E38 | 7e0b7dabbc09160c3b7ab62436b... | +I[81b5841437798bbe8ef8d73b... |  5030070719974405429 |          0.21 |                    1.409689E38 | 7e0b7dabbc09160c3b7ab62436b... | +I[81b5841437798bbe8ef8d73b... |   
```

## è¿æ¥å‚æ•°
> 

| å‚æ•°å                 | ä½œç”¨                                                         | æ˜¯å¦å¿…å¡« | é»˜è®¤å€¼ï¼ˆæ ·ä¾‹ï¼‰        |
| ---------------------- | ------------------------------------------------------------ | -------- | --------------------- |
| connector              | è¿æ¥å™¨ç±»å‹å£°æ˜                                               | æ˜¯       | http_table(å”¯ä¸€å€¼)    |
| url                    | è¯·æ±‚åœ°å€                                                     | æ˜¯       | http://127.0.0.1/test |
| request.method         | å£°æ˜è¯·æ±‚ç±»å‹                                                 | æ˜¯       | get , post ä¸¤è€…ä¹‹ä¸€   |
| request.timeout        | è¶…æ—¶é…ç½®                                                     | å¦       | 30000         ( ms)   |
| request.retry.max      | å¤±è´¥é‡è¯•æ¬¡æ•°ä¸Šé™                                             | å¦       | 3                     |
| request.max.interval   | é‡è¯•é—´éš™                                                     | å¦       | 1000           ( ms)  |
| request.thread         | è¯·æ±‚çº¿ç¨‹æ•°                                                   | å¦       | 1                     |
| request.limit.gap      | è¯·æ±‚é™é€Ÿç›¸å…³ï¼Œæœ€å¤§è¯·æ±‚å †ç§¯é‡(éä¸¥æ ¼é™åˆ¶)                     | å¦       | 3000                  |
| request.limit.sleep.ms | è¯·æ±‚é™é€Ÿç›¸å…³ï¼Œè¾¾åˆ°å †ç§¯é‡ç¡çœ æ—¶é—´(åˆå§‹å€¼ï¼Œå†…éƒ¨ä¼šæ ¹æ®å †ç§¯æƒ…å†µè¿›è¡Œè°ƒæ•´) | å¦       | 3000         ï¼ˆmsï¼‰   |

## ç»´è¡¨ä½¿ç”¨è¯´æ˜
### ç»´è¡¨å¯¹æ•°æ®ç±»å‹æ”¯æŒ

> åªè¯´æ˜ç‰¹æ®Šç±»å‹

1.  `process time` å­—æ®µæ— æ³•å‚ä¸`join`ã€‚
2.  æ¶‰åŠæ—¶é—´ç›¸å…³å­—æ®µå¿…é¡»è½¬åŒ–ä¸ºæ—¶é—´æˆ³è¿›è¡Œäº¤æ¢(é˜²æ­¢æ—¶åŒºå½±å“ï¼Œé™¤éæ—¶é—´æ ¼å¼ä¸­å¸¦æœ‰æ—¶åŒºä¿¡æ¯)ï¼›
3.  æ—¶é—´ï¼ŒDecimal ç­‰å­—æ®µå¿…é¡»ä¸€è‡´æ‰èƒ½ `join`ï¼Œå¹¶ä¸”å­—æ®µå®šä¹‰ä¸ä¸€è‡´å¼•å‘çš„ `join`ï¼Œ ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯`join ` å­—æ®µæ•°æ®è·å–å¤±è´¥ã€‚

> ## éæ³•ä¾‹å­
>
> DECIMAL(32,2) join DECIMAL(2,2) 
>
> timestamp(3) join timestamp(9)
4. **Http post æ”¯æŒæ‰€æœ‰æ•°æ®æ ¼å¼ï¼ŒGet åªæ”¯æŒéåµŒå¥—æ ¼å¼(`row ,map, array` ä¸æ”¯æŒ)ã€‚**

### ç»´è¡¨ä¸æ”¯æŒ Join çš„å½¢å¼

> åµŒå¥—ç±»å‹ join æ¯”è¾ƒç‰¹æ®Šï¼Œä»¥ row ä¸ºä¾‹ï¼Œrow æœ‰ä»¥ä¸‹ç‰¹ä¾‹

1. åŸè¡¨ä¸­å®šä¹‰çš„ `row join row` ç»´è¡¨ä¸­æ˜¯æ”¯æŒã€‚

```
# å¯ä»¥è¿™ä¹ˆä½¿ç”¨
select *  from source left join dim FOR SYSTEM_TIME AS OF source.proctime on  dim.test_row= source.test_row
```

2. ä»»ä½•æƒ…å†µä¸‹ ç»´è¡¨`row` éƒ¨åˆ†åˆ— `join` æ˜¯ä¸æ”¯æŒã€‚ï¼ˆæºè¡¨ row éƒ¨åˆ†åˆ—ï¼Œä¸æ¶‰åŠå¤æ‚åµŒå¥—ï¼Œå¦‚`3.`äºŒæ¬¡ä½¿ç”¨ row å‡½æ•°éƒ½èƒ½æ­£å¸¸ä½¿ç”¨ï¼‰

> `LookupTableSource` ä¸­`LookupContext` æ¥å£æè¿°æ˜¯**æ”¯æŒ**ç»´è¡¨åµŒå¥—ç±»å‹éƒ¨åˆ† `join`ï¼› ä½†æ˜¯ `LookupContext` æ¥å£çš„å®ç°ç±» 1.12 ä¸­`CommonLookupJoin.lookupFunction`  **æ ‡æ˜åªæ”¯æŒ top level join ï¼Œå³ä¸æ”¯æŒåµŒå¥—ç±»å‹çš„éƒ¨åˆ†åˆ— joinï¼›ï¼ï¼ï¼è¯­æ³•ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æ— æ³•æå– join å­—æ®µï¼ï¼ï¼** 

```
# ä¸å¯ä»¥è¿™ä¹ˆä½¿ç”¨ï¼Œè¯­æ³•ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æ— æ³•è·å– join åˆ—ä¿¡æ¯
select *  from source left join dim FOR SYSTEM_TIME AS OF source.proctime on  dim.test_row.a = source.test_row.a
# æºè¡¨ row éƒ¨åˆ†åˆ—æ˜¯ join ç»´è¡¨çš„é row åµŒå¥—åˆ—
# å¯ä»¥ join 
select *  from source left join dim FOR SYSTEM_TIME AS OF source.proctime on  source.test_row.a = dim.test_string
```

3. `Row` å‡½æ•°æ„é€ çš„åˆ—ä¼šå¼•å‘ bug 

> ç±»ä¼¼ bug æŠ¥å‘Š(row å‡½æ•°å¤šé‡åµŒå¥—ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„)
>
> https://issues.apache.org/jira/browse/FLINK-20922 

```
# ä¸å¯ä»¥
select  * from source  left join dim FOR SYSTEM_TIME AS OF source.proctime on dim.test_row.a= source.test_row.a
# ä¸å¯ä»¥
select  * from source  left join dim FOR SYSTEM_TIME AS OF source.proctime on dim.test_row.a= Row(source.`a`)
```

## Http ç»´è¡¨å®ç°è°ƒç ”
   
- åŠŸèƒ½ç‚¹

1. HTTP æ”¯æŒå¼‚æ­¥ï¼Œæ€§èƒ½è¦è¶³å¤Ÿå¥½ï¼Œæ’éšœé—®é¢˜å®šä½è¦ç®€å•
2. æ”¯æŒ HTTP Get å’Œ HTTP Post è¯·æ±‚
3. HTTP æ”¯æŒè¿æ¥å¤ç”¨ï¼Œæœ‰è‡ªåŠ¨é‡è¯•ï¼Œè¶…æ—¶ï¼Œç©ºé—²è¿æ¥è‡ªåŠ¨é‡Šæ”¾(å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨é•¿æœŸç©ºé—²è¿æ¥ï¼Œæˆ–è€…æ˜¯æœåŠ¡ç«¯é•¿æ—¶ç©ºé—²ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œclient ç«¯æ— æ³•æ„ŸçŸ¥æ–­å¼€ç­‰é—®é¢˜)

4. æœ‰ä¸€å®šè¯·æ±‚é™æµï¼Œå†…å­˜æ§åˆ¶èƒ½åŠ›

5. ä¿ç•™ http 2.0 æ”¯æŒèƒ½åŠ›ï¼Œåç»­èƒ½ç®€å•å‡çº§æ”¯æŒ

#### Http æ–¹æ¡ˆå¯¹æ¯”

|                                                       | ä¾èµ–                                                    | æ€§èƒ½                                                 | å¯é æ€§                                          | å¼€å‘éš¾åº¦                                                     | ç‰¹æ€§                               |
| ----------------------------------------------------- | ------------------------------------------------------- | ---------------------------------------------------- | ----------------------------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| Netty                                                 | Flink åŸç”Ÿ                                              | ä¸€èˆ¬(æ²¡æœ‰è¿æ¥å¤ç”¨ä¸‹ï¼Œæ€§èƒ½è¾ƒå·®ï¼›è¿æ¥ç®¡ç†å®¹æ˜“å‡ºç°é—®é¢˜) | å¯¹æ–°æ‰‹ä¸å‹å¥½ï¼ŒåŸç”Ÿå¯é æ€§éœ€è¦å¤§é‡ Netty çŸ¥è¯†ä¿éšœ | éš¾ï¼Œåº•å±‚çŸ¥è¯†ç‚¹å¤ªå¤šï¼ŒNetty å­¦ä¹ æˆæœ¬æ¯”è¾ƒé«˜ï¼Œå¾ˆå¤šå¼‚å¸¸æƒ…å†µéƒ½éœ€è¦è€ƒè™‘ï¼Œå—é™äº Netty çŸ¥è¯†ï¼Œéœ€è¦è‡ªè¡Œè§£å†³èµ„æºå›æ”¶ï¼Œå¼‚å¸¸å¤„ç†ï¼Œè¿æ¥å¤ç”¨ç­‰æƒ…å†µï¼ˆhttp 1.1 éœ€è¦è‡ªè¡Œå®ç°é•¿è¿æ¥å¤ç”¨ï¼Œä¸Šè¿°é—®é¢˜éƒ½æ˜¯å®é™…å¼€å‘é‡åˆ°çš„é—®é¢˜ï¼‰ï¼› | å†…å­˜é™åˆ¶ï¼Œå†…å­˜æ³„æ¼æ£€æµ‹ç­‰é«˜çº§ç‰¹æ€§   |
| **[Reactor](https://github.com/reactor/reactor)**     | åº•å±‚ä¾èµ– netty ï¼Œä¸ºé˜²æ­¢ä¸ Flink ä¾èµ–å†²çªå¿…é¡» shade å¤„ç† | å¥½                                                   | æ¯”åŸç”Ÿ Netty æ›´åŠ é è°±                           | ä¸€èˆ¬ï¼Œæ²¡æœ‰å®é™…å¼€å‘æµ‹è¯•è¿‡                                     | Netty æ‹¥æœ‰çš„ç‰¹æ€§éƒ½æœ‰ï¼Œæ›´åŠ ç®€å•æ˜“ç”¨ |
| [AsyncHttpClient](https://github.com/AsyncHttpClient) | åº•å±‚ä¾èµ– netty                                          | å¥½                                                   | æ¯”åŸç”Ÿ Netty æ›´åŠ é è°±ï¼Œä½†æ˜¯ä¸æ”¯æŒ http 2.0      | ä¸€èˆ¬ï¼Œæ²¡æœ‰å®é™…å¼€å‘æµ‹è¯•è¿‡                                     |                                    |
| Apache Http client 5                                  | å¤–éƒ¨                                                    | å¥½                                                   | æ²¡æœ‰å†…å­˜æ³„æ¼æ£€æµ‹ç­‰é«˜çº§ç‰¹æ€§ï¼Œé¡¹ç›®æ¯”è¾ƒè€          | è¾ƒç®€å•ï¼Œæ–‡æ¡£æ¯”è¾ƒå‹å¥½ã€‚ç±»ä¼¼ Netty çš„ Reactor æ¨¡å‹ï¼Œå¹¶ä¸”è‡ªåŠ¨ç»´æŠ¤é•¿è¿æ¥ï¼Œä½¿ç”¨ç®€å•ï¼Œå®Œæˆå¤§é‡åº•å±‚çš„æ“ä½œã€‚ä½†ç¼ºå°‘é™æµæ–¹æ¡ˆ | é»˜è®¤ Http 1.1 è‡ªå¸¦é•¿è¿æ¥å’Œè¿æ¥å¤ç”¨ |
| OkHttp                                                | å¤–éƒ¨                                                    | æœ€å·®                                                 | å®‰å“å¤§é¢ç§¯ä½¿ç”¨                                  | ç®€å•                                                         |                                    |

